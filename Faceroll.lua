-- World of Warcraft Faceroll Logic

-- WAs:
-- FaceRoll:                !WA:2!DA1ZVnoru4gvKwrufnKTSQc4WqyPIvGIwQ0UQCOAvC(bTqsDX2D7UId2J9mozaNzSMzC3eogXbUShOA)licjUG4q2Y1vO9osMQvCgv4mhwH4mJTtlUSTePyPO8EJ)MV5nFVNN3uOv5(LrLrF9n4SizaHI567z1E7DAEmms2JX1dLegvuCcIicdGdTWdKvEhVXErcjRFIx4n9JOEjOE3BueOE4yzeNcQ0YaubuTkagXH2y6bv7Zq4Iyk6yrpiI9G7R77lWY3CHjqQNAP2LrOsxnDll9oHGCRNTpJ3hkTdTLK(4PEfcl9VXWEHiOeBGpatLNOcCMcaXBFcs2tRMYLdtdqXTnesixwuJqjY1oeXSZ4WXn7)WvoxWc2euPJEfxFfCrVIJKCs3UyU4vwJp18x1KddXXx9erKB6QBg57tgmXUEntlBtRAgwJqkktw91Vz1nIx6P17bLGoyHa2fF202LJvtZWC3MTBpjlwS7rqyJKDmAKieheSnsum(QdEPF8m9oDQVpaY7MP8eFq6qGnvbUAXT2ZScGXZnO(UwBRVJAuzpmnDoQ8r6)VibTQvVPHE7221AMdFYZliskeN9YPPFjpcFUf4I520AwCRqmNCVtRzXTcXCYT(oZIBfI5KBnTzXTcXCYDdZzXTcXCYDNzYDN5M79NzDY(ZDDsTzwNuBURt2QXS4wHyEZL1MTINIzo5V923DMF5NI5)L)KFQNSZ5eHpk3XkGChdaY9zli3NzGCFwaYvgdYv2bYvMaa5YRGC5bW50nW52LNEKB6H5lzqH9XIIArQMeUjnHW8XiSR6KDl175B1S9UT2R9Hr0Pnbkg(Qj9xoaBL53rPnF)cHvU8wyk1Zw1ua7eU2Ldka3f6n02pGX49ouGd8t7qg)YA(mQ84w6g1B2ay(P7vZO5yvJedC3KECV(1Ix9yLRl07l6Q6QtrAbmiY)eVaOqydPiBv7eV1CfeA3a8dn6hfij)9rFMZrl7Gk58qNFX5zl7CujNvUUZFTSZFSSZp78noxVKZJk5il54kHbQm51I3Oyy5ib2(882Zi1p51Aj(zgKVeNymkjYnvoBo9oa3l7oalYhKzuympDxKi0AsLMCiKs6N2(82XLAfVQgLrXpfdfytjht7k7DLJpTbBA6JlWEmksmkbtcnXn06dju1CJBe38kXTI)O4TuMV2)DKNRexmNcdURIefDFx4BF5jNqo2JKGAXXQg3yu6Dn(QLcFJlCkzgXVLHhlGX)4TUZF(KN8BlSWclU1D(9h)4FkXI)5QsqI)qT2nBznwY8oilkwTWpSsfcAulOh2GfeSEebnX8(B8j641FaFWGj(Cv1QsmGs4Ipp7MuTsgkzV7Aw3OzZD4dZu3VDzxL24t6wm89U8TgAOQ(N4zl7XXIESa0WrpGXr7ZHHJ2FQXKS0x90TtHcfwCCIOtMExrcnJrLxXlur8ovrAuw4ERQFWhw9wLp4z37Fc
-- FaceRoll Enable/Disable: !WA:2!9A1ZVTrXx8y5dvYcPyslPLasD1sjKqlM0K2q5RuLA2uB1wzhhT2PTOIy3z3zwVtZ6zgnZSPXCmcH4sLGi(lWx4cIdw9pa037iTe1)cQ4VGkeN5n764scnieQWiz53BM38EV5Z7xBPgZ0Fg8m4V69L8uDcLrKT3QBZBVrD5UTJIue9T(rXdkFJPMQ0imvjsqd6s2vB)UHddtvAEFdN49IszHAkNTWIvSGLKOtLmluQe5ry7uRphtQqy4duXim)rFsHMF7PgHyHXC5MCkthSE9n6w3vy9hmJxex2hP9eEAAFYyUsIQVW0BjWinjin)VNHsHTrAA49OyDSZAaReL7yQvDvAKuxXHYO653hZ9kuIFqX)IVEI3gjxNNWLwx3AYZsdM6swHMTpYl0(tV8YxjmkY2QwTIJnegPn)NFQ028YRu5iGbO7JBUfSB3OH9LSSxjFzVyqe4QQ4k7PL0E9is1NnVCm5xoedV5OOUdee5TQ3CZgB10rdmUgTU8Ekbjj52yvLNPsdi7qy6oG00Dh5T(AD661P7AUDDsbGiWG0ePld1NOQ4MlAWTiOeD8KRUPKax1TZM1B2C)u2yxOY8zNDNS5YoDHqkXknwB96UTB20R(gR50SU1X49CA9ITU5T7y2Bub27zC9m7d5IPyIRjGJZo9ULp)KGqUHkGFAubN11VUL9XmK9Iw6yclxUczFbwhYzr0E1cJr6JkKzjKqA4c2nqHexEsY)ZkpQ(NJt1zOGec2AHnm5JjlAcAlTuu0slzV4It0OjOFi9eI)gjbByuhcwg1n5IJZ30Yus(EKef5Vcea0()oCWPvogyqGxjya475yW1U2)qmyC61)6iWnPQCi4v6R)yTbo5NpOE4x25YEZSZNzLnFfth6hMxTSdzzeBG41r50DlkzBbw87Ns8wV0gSfezxum)j3)nH0dfoWlkHZLX7JyutVwoB1SQnYMZHXzK)pbPiD0scRNo(uhGHhNrI8cCPIaGowTNrgtNRSvC6JOm4UzRKDLtLD1SvZ(iG8no(oorCMwuTbvISAXzCRwemnT)qOdLlPNP7(CZMn3baBakC7EWKmg2jHJWrplmbPuEig2d6jgoFGIY6LqESB)0en93EYd8FY0(4Q(p2)N9F60(pPQ)zUG)VoT)VmT)p5)n(xOQ)3w1xx1pqJsGSSzZUrfXmPkI3r1BSBoV5yhdFbb9ZjgI9mEFhG5dgp(7(fJ)kVCkfpQvDcz1T7sASGyOm)XyGghZiKHGH6Y5GJkI3xrsIkMt60UB32Tgc9Kj485CFXRjENtoOjKKqQc0B5Nd3MizOK7cXcyJVtCXt(A4bWmbAONowsuX8e8a385B3PmSKpe6utJga1yn6ouZd3PqJNR0pCgBkwC2dRCSk6r8HJlu27rCj(EsKyV7nMyuKeg9azminQ8Zl(CGgMTmOqqN1DRxFdH9j7MqvKhCxcmgpVGEwhtfDSCWHF8YGTU7uW6a4tdav3wK)XaZbtUc08EqQWYBtgK55GjQqXSBAQ7TanW6ruwAUHuxtcXHBcN77ygtEqHqWHRdhkXKieKlf7(itOO8OIqCEP8DkvQu5HMCEAUvRmIYk8EGRYlTom8W6WvMrfC1Ax(JRD1z25P3)3d
-- FaceRoll Labels:         !WA:2!1rvqlYrru4zyoeOrYoozZIy8WA0SzLabsIjyGaXPh7XzxMSZMQ71nIh6Q6UQE6sRPQovv9MDYjzmibKqWfpKd50GGxepmKFaI3fBgZrpTKdEEXFaPQUhcAW9u)EV(RQ699vFVQE3wJAHBHF45LICnJYjYb7e0FJT8aXcMqUzVB(3p5j)ATA16DZxO1FDzWF90NAQuVr2fWuvgdnoGSVomrihH0HzHA6isiEmhnIghQtLevQGHhlhpijrr03y5ziECQqUTGY1rD82kWdKT6XVvvz1ZAgNR0Irwe7KHrAcGShHRpeLBQI004DPyDQBBtQefRPcU6AaLgj1oUuov7eLy(OsDMOL0Hdjs1jxtUi8BNIjr5jjbJZiYEE93U7o9D1MeakxIU8evgHX2aRCouLhvES(g009Nf2PTFqOFqBqGBU5qISKGiFfSTLedmG)2E97x4e1JGy6uGrBikNdY5loENS302X7rcQYVLat(5AzN94fLrcCO0ObWJmIirYrSpZqidN)PdqCQvoe8RvCYUfN2Ll4KFJGueFTKWhQtpXCSHuweHwkkvKybhRMyXyfGIZ5ocr5M1wCUI1orX5lwV4dmHnF9kUjcUEE3bGoEFYQ(3EN2aVPgIdidTI)BVsXPNBsJqXF1qJ9IJDzceo5WygsPcrCCOrwJxbmkNPPp8u)ZsqCtOUj8rWVh(NWFOj85lb)XMWN9fWN1e(nWxSe8XWLFF4VdFGP4sW)agPrmJgVsXLCYALRiH)3DofuMB)TB5jvgqVpXgmX27(MK3DUkfHf37ov2ZgtLLTVviC1gHxUF1p69Xt(oODsiBTJ)AHrgIIhhMWeczA27D8aZKKyQ9(Qr2z(FrvfaSGXtnwicU0E)G3yr7(5vD17ut(LMXcAYyayJpTxWuTiEVkNWBv)xw(Su8rDrXeGGXwTpkIWutUNqI3vIYMS7IGzjsJF04oqAuJJQgo7Alz1Gi)oapVTUCofp7U3EZnV(viF4hDL1JmwMe6qN5MPpd8bzLZBoZ(xCr6h440EG3SQgUt57j1RxVXuRDJUybuEftnzohOiSKQNfCheem4wTurx9Ix66x8QT27535L)
-- FaceRoll Labels Bear:    !WA:2!1r1ZVnoru4eLdizwb7gvfHaouwKwoGuLOsBLw6clXPoKSkTPm29hCYDSNNJhy8mdZmUTHtOieAp3t7H9uUWfehYFbi(lWeXrovTh2Z9VGDM4ieGON87n(988999(EUz)2fTjTjp7JuIsdJYb14JIgn8GauQGjupDWtE1ZF(V1OrJbp5LgZpSk4VEXlSN0S1ccvlz4PrWLM5JgECGN3ED3pCPohtex81JZY0G59BSaZtZfQdfuUjPxWbrbi5M)JwJZeQcSjwgBOfW6SMY7MwQnIcxfhjjydGGZbU5ACP9uSHMEcLyY97Atv4udvW17G0gSY4LKr5uDUNV9HXBMrrNmbu636bQ1H)0CcKuMLfnvcQbbJoS)rJ8n2eeUuH3EMwcm2qI27ADzYQRn0wn9YfX96ggfhg1ff5xA)4josakehxaAVQ3mzaGzM8)UTdvGTnu4HbJgDvjF917jVNdXNdr157liWV0q(E)VIsDaYPnKBSsiO4y2Xw6yz8pFLgyz1kR)4OOX77Nj4ML9hJ6fS3MHF1rDrbZTGbbtCc072PQZsBAco9BNyN4CIptGjzxNYWADmMtITupTdQOKzOD(JZsmyMLgDQ2YdTQgxKSDPgI)3TK7VQr7B910VhCbZCqj0M8bRDeNw7iAnxTcnoX33y5Q8JVD3azQvAPPXMCfOZfmY0RWCQB(l47u929)DaRHqJc4tm5VrvhFUGdlj2PORIy3mvPHubNON5k1DPv76xGP8(vFQTHQDREC1Nv952N39)EI8dVDGjvqk1ndAjV)TxvHGeBHcC2CheORCPElTwy7cXyzDQ6BSgDA2ueA4xoiAUrKEE909DA(RBCFkrUrFCkGem2MJWjatVPpGvQP1Q5J3yrMY6(SAa2GBDt9YwF3roUMe2dfeCqI96ZOt82UKswqggL(OTL69d(o1L1FLbFXSDpZTMp7cHICIclNDY6Gf1dVER(DqZMnBn36ObYQTVF8olO8AgBXRN8b3UsWGj40PXzmHqL3wN8WT(KhT1dBF(FE6R)

function FRDEBUG(text)
    -- print("Faceroll: " .. text)
end

-- Constants
local KEY_TOGGLE = hs.keycodes.map["F5"]
local KEY_Q = hs.keycodes.map["q"]
local KEY_E = hs.keycodes.map["e"]
local KEY_SLASH = hs.keycodes.map["/"]
local KEY_ENTER = hs.keycodes.map["return"]
local KEY_DELETE = hs.keycodes.map["delete"]

local AUTOMATIC_STOP_TIME = 0 -- 50 * 9

-- Actions
local ACTIONS = {
    ["Q"] = {0,0,0}, -- set by toggleBMAOE()
    ["E"] = {0,0,0}  -- set by toggleBMAOE()
}

-- Globals
local facerollActive = true
local facerollMode = nil
local facerollTick = 0
local facerollCountdown = 0
local facerollBM = true -- immediately disabled on load

local wowApplication = nil
local function sendKeyToWow(keyName)
    -- if wowApplication == nil then
        wowApplication = hs.application.applicationsForBundleID('com.blizzard.worldofwarcraft')[1]
    -- end
    if wowApplication ~= nil then
        hs.eventtap.keyStroke({}, keyName, 20000, wowApplication)
    end
end

local function updateActions()
    if not facerollActive then
        print("Faceroll: OFF")
    elseif facerollBM then
        print("Faceroll: BM (F7 pressed exclusively on occasion)")

        ACTIONS["Q"] = {
            "7", "8", "9", "0", "-", "=", "pad7", "pad8", "pad9",          -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            0,0,0,0,0,0,0,                                                 -- wait
        }

        ACTIONS["E"] = { -- BM AoE (presses F7 a bit every 6 seconds)
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            0,0,0,0,0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            0,0,0,0,0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            0,0,0,0,0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            0,0,0,0,0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            0,0,0,0,0,0,0,                                                 -- wait

            -- "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            -- 0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            -- 0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            -- 0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        }
    else
        print("Faceroll: ON (Regular AOE Active)")

        ACTIONS["Q"] = {
            "7", "8", "9", "0", "-", "=", "pad7", "pad8", "pad9",          -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        }

        ACTIONS["E"] = { -- standard AoE
            "F7", "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        }
    end
end

local wowTick = hs.timer.new(0.02, function()
    if facerollMode == nil then
        -- FRDEBUG("BAIL 1")
        return
    end

    if facerollCountdown > 0 then
        facerollCountdown = facerollCountdown - 1
        if facerollCountdown <= 0 then
            FRDEBUG("Faceroll: Countdown Reset")
            facerollMode = nil
            return
        end
    end

    local actions = ACTIONS[facerollMode]
    if actions == nil then
        -- FRDEBUG("BAIL 2")
        return
    end

    local actionCount = #actions

    local key = actions[facerollTick + 1]
    if key ~= 0 then
        -- FRDEBUG("FACEROLL KEY: " .. key)
        sendKeyToWow(key)
    end

    facerollTick = facerollTick + 1
    if facerollTick >= actionCount then
        facerollTick = 0
    end
end, true)

local function setFacerollActive(active)
    if facerollActive ~= active then
        facerollActive = active
        facerollMode = nil
    end
end

local wowTapKey = hs.eventtap.new({hs.eventtap.event.types.keyDown}, function(event)
    -- local flags = event:getFlags()
    local keyCode = event:getKeyCode()
    -- FRDEBUG("lole key " .. keyCode)

    if keyCode == KEY_SLASH or keyCode == KEY_ENTER or keyCode == KEY_DELETE then
        setFacerollActive(false)
    elseif keyCode == KEY_TOGGLE then

        facerollTick = 0
        if facerollActive then
            if facerollBM then
                facerollActive = false
                facerollBM = false
            else
                facerollActive = true
                facerollBM = true
            end
        else
            facerollActive = true
        end

        updateActions()

        if facerollActive and facerollBM then
            sendKeyToWow("6")
        elseif facerollActive then
            sendKeyToWow("[")
        else
            sendKeyToWow("]")
        end
    elseif facerollActive then
        if keyCode == KEY_Q then
            FRDEBUG("Faceroll: Q")
            if facerollMode ~= "Q" then
                facerollMode = "Q"
                facerollTick = 0
                wowTick:stop()
                wowTick:start()
            end
            facerollCountdown = AUTOMATIC_STOP_TIME
            return true
        elseif keyCode == KEY_E then
            FRDEBUG("Faceroll: E")
            if facerollMode ~= "E" then
                facerollMode = "E"
                facerollTick = 0
                wowTick:stop()
                wowTick:start()
            end
            facerollCountdown = 0
            return true
        end
    end
end)

local wowTapFlags = hs.eventtap.new({hs.eventtap.event.types.flagsChanged}, function(event)
    if facerollMode ~= nil then
        FRDEBUG("Faceroll: Reset")
        wowTick:stop()
        facerollMode = nil
    end
end)

local function enableFaceroll()
    FRDEBUG("enableFaceroll()")
    wowTapKey:start()
    wowTapFlags:start()
end
local function disableFaceroll()
    FRDEBUG("disableFaceroll()")
    wowTapKey:stop()
    wowTapFlags:stop()
end

local WoWFilter = hs.window.filter.new(true)--"Wow")
WoWFilter:subscribe(hs.window.filter.windowFocused, function(w)
    if w == nil then
        FRDEBUG("Focus: w is nil")
    else
        FRDEBUG("Focus: " .. w:title())
        if w:title() == "World of Warcraft" then
            enableFaceroll()
        end
    end
end)
WoWFilter:subscribe(hs.window.filter.windowUnfocused, function(w)
    if w ~= nil then
        FRDEBUG("Unfocus: " .. w:title())
        if w:title() == "World of Warcraft" then
            disableFaceroll()
        end
    end
end)

print("Faceroll loaded.")
updateActions()
