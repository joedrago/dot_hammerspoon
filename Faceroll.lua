-----------------------------------------------------------------------------------------
-- World of Warcraft Faceroll Logic

-- WAs:
-- FaceRoll:                !WA:2!DA1ZVnoru4gvKwrufnKTSQc4WqyPIvGIwQ0UQCOAvC(bTqsDX2D7UId2J9mozaNzSMzC3eogXbUShOA)licjUG4q2Y1vO9osMQvCgv4mhwH4mJTtlUSTePyPO8EJ)MV5nFVNN3uOv5(LrLrF9n4SizaHI567z1E7DAEmms2JX1dLegvuCcIicdGdTWdKvEhVXErcjRFIx4n9JOEjOE3BueOE4yzeNcQ0YaubuTkagXH2y6bv7Zq4Iyk6yrpiI9G7R77lWY3CHjqQNAP2LrOsxnDll9oHGCRNTpJ3hkTdTLK(4PEfcl9VXWEHiOeBGpatLNOcCMcaXBFcs2tRMYLdtdqXTnesixwuJqjY1oeXSZ4WXn7)WvoxWc2euPJEfxFfCrVIJKCs3UyU4vwJp18x1KddXXx9erKB6QBg57tgmXUEntlBtRAgwJqkktw91Vz1nIx6P17bLGoyHa2fF202LJvtZWC3MTBpjlwS7rqyJKDmAKieheSnsum(QdEPF8m9oDQVpaY7MP8eFq6qGnvbUAXT2ZScGXZnO(UwBRVJAuzpmnDoQ8r6)VibTQvVPHE7221AMdFYZliskeN9YPPFjpcFUf4I520AwCRqmNCVtRzXTcXCYT(oZIBfI5KBnTzXTcXCYDdZzXTcXCYDNzYDN5M79NzDY(ZDDsTzwNuBURt2QXS4wHyEZL1MTINIzo5V923DMF5NI5)L)KFQNSZ5eHpk3XkGChdaY9zli3NzGCFwaYvgdYv2bYvMaa5YRGC5bW50nW52LNEKB6H5lzqH9XIIArQMeUjnHW8XiSR6KDl175B1S9UT2R9Hr0Pnbkg(Qj9xoaBL53rPnF)cHvU8wyk1Zw1ua7eU2Ldka3f6n02pGX49ouGd8t7qg)YA(mQ84w6g1B2ay(P7vZO5yvJedC3KECV(1Ix9yLRl07l6Q6QtrAbmiY)eVaOqydPiBv7eV1CfeA3a8dn6hfij)9rFMZrl7Gk58qNFX5zl7CujNvUUZFTSZFSSZp78noxVKZJk5il54kHbQm51I3Oyy5ib2(882Zi1p51Aj(zgKVeNymkjYnvoBo9oa3l7oalYhKzuympDxKi0AsLMCiKs6N2(82XLAfVQgLrXpfdfytjht7k7DLJpTbBA6JlWEmksmkbtcnXn06dju1CJBe38kXTI)O4TuMV2)DKNRexmNcdURIefDFx4BF5jNqo2JKGAXXQg3yu6Dn(QLcFJlCkzgXVLHhlGX)4TUZF(KN8BlSWclU1D(9h)4FkXI)5QsqI)qT2nBznwY8oilkwTWpSsfcAulOh2GfeSEebnX8(B8j641FaFWGj(Cv1QsmGs4Ipp7MuTsgkzV7Aw3OzZD4dZu3VDzxL24t6wm89U8TgAOQ(N4zl7XXIESa0WrpGXr7ZHHJ2FQXKS0x90TtHcfwCCIOtMExrcnJrLxXlur8ovrAuw4ERQFWhw9wLp4z37Fc
-- FaceRoll Enable/Disable: !WA:2!fwvqVXrTx8SApG0iKY2OO0s(JeJgAJA)3sijLwkcvjYKSRsk7MnA2nTffkZ4zSNDCZS2w2EsYcIlrvOEPhiIpb7fUG4WQ(baXDKgI6rovXNGk(aWZZKMswsewAx73BE)E(5N)9EUsJP6pfEk8t))sEMoLYiY2B1T56Bu3lINYL3RkmexhtvIu0GUK91(XCzFK2x4RP9j(4bmuFAKVorsuj8u8GHrzknVVXwXhhNXI0uo7QxZYggsIotYSrzsKpHT7895yIA7tj(ilcdFKkbH579fTJJve97oXielkHl3Ktz6WvQVr36Ec7ZpOkLQiQ9MqzlbgPjHzftVeLbQrAA0dOyDI7YGOeveOQB7P0iP2kmMYOQelxysp3HyUFPZcclN3VYvojUJLRysw231(KZRg2ZByxKdp1r35lxCPpkko2XE(5l)SzHXAZCXxLoMuGL1PZsGZ)MVDmDBVWJa1Jhgx1PDJgo3W25MfdNRnoQfphuByaHGXcl8VbT0zdYTvjO7CNcqNgfGyHd0sAVEeP6RMtE8YVBigUjIJ7oqqKRvV5Mn2QPRge8mOx6aLGKMUowz9svwizxct3bSMU)i)vwUtx)oDx2RRBgCTeAU)jspGcsuwEfMgUgbLQtob6Msca1RZM1B28Wm2XHG1C5xC38zZNU0iL4MnwEL6ETB20V(gl72SU9yY(UTEJQvxVJr3OsMGVj0ZDYFVC78lL)o5tl(JtObfEVKaqJlLSV7DTDgZ7oxZwNqyf2zgJNfpT81Tx8elpMwPLzKcDKuf5S3PJd6)RTAHZ31aPe(96tDcft8mLB485SgbfJpU4qVlzjeBG4cOI1Dlt3TaF)tti(FNzjB5I8Bmmtr6Y5PAQi5qfjnUSC3TD3UTB5gZzArTgujYUfNXTBrW0S(dHRzpsptH7SZKp7rGyikANEq3mg2nLJWXVmkfPu(ig2hiwrZfQOSEPKN51pd2QNw75Bh88jdW1cEwWVh8IjdEsTGNxlqxl4VMm4hQf8BbFFWLRf8Ntgm9Ldc1OuiXot(NA5v4wZkXuqG7F6DjX18V5RUk6xtmloWCc6acFWXD3Eyz3TQHrCwmT3mUrjiDYqzXXXuB4AAlCiIrnTQ4SBNxRXVsqkshTKW6PtER8zDzCg5imChASOGjkveWHy1bgtnUjFD3(ikRr(AaG81ZVx(NN3eMVW4AEfKUjsgk9(Gta39JdnoIw0w0s8(NF)wHKerniQo6FyKZvIeZD(Gsj9qrd8Jt5CzIC)YKXA)Iy7QF2etur(yGLrJham2gDhQ5r7wgtxQYppTdflUydueXJNMAxNHctjF4QuLzwo41oAWw3FcymkwcDhGugsJQ(QY3rAyuzsnHDwXRE9neoNFycLf(awsWszu8Ow1jKBVtxsJRkoypUe)ajsCWdoEXrWZkG3BlkYyZc9xc18EaxBPDidYx1BpZJnvLysmcOEjUM2whTPeY62AU9kWTVeysRsurbUql3iXmLFe4fSEWlaGrgkY8Jk5pfDGVxLkvQoe6WrWfVL9K3EeLvEcGGW6ml5IEDj36tPcV18l(jZFRP29fp8V)d
-- FaceRoll Labels:         !WA:2!1rvqlYrru4zyoeOrYoozZIy8WA0SzLabsIjyGaXPh7XzxMSZMQ71nIh6Q6UQE6sRPQovv9MDYjzmibKqWfpKd50GGxepmKFaI3fBgZrpTKdEEXFaPQUhcAW9u)EV(RQ699vFVQE3wJAHBHF45LICnJYjYb7e0FJT8aXcMqUzVB(3p5j)ATA16DZxO1FDzWF90NAQuVr2fWuvgdnoGSVomrihH0HzHA6isiEmhnIghQtLevQGHhlhpijrr03y5ziECQqUTGY1rD82kWdKT6XVvvz1ZAgNR0Irwe7KHrAcGShHRpeLBQI004DPyDQBBtQefRPcU6AaLgj1oUuov7eLy(OsDMOL0Hdjs1jxtUi8BNIjr5jjbJZiYEE93U7o9D1MeakxIU8evgHX2aRCouLhvES(g009Nf2PTFqOFqBqGBU5qISKGiFfSTLedmG)2E97x4e1JGy6uGrBikNdY5loENS302X7rcQYVLat(5AzN94fLrcCO0ObWJmIirYrSpZqidN)PdqCQvoe8RvCYUfN2Ll4KFJGueFTKWhQtpXCSHuweHwkkvKybhRMyXyfGIZ5ocr5M1wCUI1orX5lwV4dmHnF9kUjcUEE3bGoEFYQ(3EN2aVPgIdidTI)BVsXPNBsJqXF1qJ9IJDzceo5WygsPcrCCOrwJxbmkNPPp8u)ZsqCtOUj8rWVh(NWFOj85lb)XMWN9fWN1e(nWxSe8XWLFF4VdFGP4sW)agPrmJgVsXLCYALRiH)3DofuMB)TB5jvgqVpXgmX27(MK3DUkfHf37ov2ZgtLLTVviC1gHxUF1p69Xt(oODsiBTJ)AHrgIIhhMWeczA27D8aZKKyQ9(Qr2z(FrvfaSGXtnwicU0E)G3yr7(5vD17ut(LMXcAYyayJpTxWuTiEVkNWBv)xw(Su8rDrXeGGXwTpkIWutUNqI3vIYMS7IGzjsJF04oqAuJJQgo7Alz1Gi)oapVTUCofp7U3EZnV(viF4hDL1JmwMe6qN5MPpd8bzLZBoZ(xCr6h440EG3SQgUt57j1RxVXuRDJUybuEftnzohOiSKQNfCheem4wTurx9Ix66x8QT27535L)
-- FaceRoll Labels Bear:    !WA:2!1r1ZVnoru4eLdizwb7gvfHaouwKwoGuLOsBLw6clXPoKSkTPm29hCYDSNNJhy8mdZmUTHtOieAp3t7H9uUWfehYFbi(lWeXrovTh2Z9VGDM4ieGON87n(988999(EUz)2fTjTjp7JuIsdJYb14JIgn8GauQGjupDWtE1ZF(V1OrJbp5LgZpSk4VEXlSN0S1ccvlz4PrWLM5JgECGN3ED3pCPohtex81JZY0G59BSaZtZfQdfuUjPxWbrbi5M)JwJZeQcSjwgBOfW6SMY7MwQnIcxfhjjydGGZbU5ACP9uSHMEcLyY97Atv4udvW17G0gSY4LKr5uDUNV9HXBMrrNmbu636bQ1H)0CcKuMLfnvcQbbJoS)rJ8n2eeUuH3EMwcm2qI27ADzYQRn0wn9YfX96ggfhg1ff5xA)4josakehxaAVQ3mzaGzM8)UTdvGTnu4HbJgDvjF917jVNdXNdr157liWV0q(E)VIsDaYPnKBSsiO4y2Xw6yz8pFLgyz1kR)4OOX77Nj4ML9hJ6fS3MHF1rDrbZTGbbtCc072PQZsBAco9BNyN4CIptGjzxNYWADmMtITupTdQOKzOD(JZsmyMLgDQ2YdTQgxKSDPgI)3TK7VQr7B910VhCbZCqj0M8bRDeNw7iAnxTcnoX33y5Q8JVD3azQvAPPXMCfOZfmY0RWCQB(l47u929)DaRHqJc4tm5VrvhFUGdlj2PORIy3mvPHubNON5k1DPv76xGP8(vFQTHQDREC1Nv952N39)EI8dVDGjvqk1ndAjV)TxvHGeBHcC2CheORCPElTwy7cXyzDQ6BSgDA2ueA4xoiAUrKEE909DA(RBCFkrUrFCkGem2MJWjatVPpGvQP1Q5J3yrMY6(SAa2GBDt9YwF3roUMe2dfeCqI96ZOt82UKswqggL(OTL69d(o1L1FLbFXSDpZTMp7cHICIclNDY6Gf1dVER(DqZMnBn36ObYQTVF8olO8AgBXRN8b3UsWGj40PXzmHqL3wN8WT(KhT1dBF(FE6R)

-- Macros:
-- FRON  ('['): /run WeakAuras.ScanEvents("FACEROLL_ENABLE")
-- FROFF (']'): /run WeakAuras.ScanEvents("FACEROLL_DISABLE")
-- FRBM  ('6'): /run WeakAuras.ScanEvents("FACEROLL_ENABLE_BM")

-- Keybinds:
-- '[', ']', '6'            - see macros
-- 7890-= num7 num8 num9    - ST rotatoe
-- F7-F12 num4 num5 num6    - AOE rotatoe
-- Q, E, F5, /, enter, del  - automatic (see below)

-----------------------------------------------------------------------------------------
-- Basic debug stuff

function FRDEBUG(text)
    -- print("Faceroll: " .. text)
end

-----------------------------------------------------------------------------------------
-- UDP socket listening for game bits

function onGameBits(newBits, addr)
    print("onGameBits: " .. newBits)
end
server = hs.socket.udp.server(9001, onGameBits):receive()

-----------------------------------------------------------------------------------------
-- Constants

local KEY_TOGGLE = hs.keycodes.map["F5"]
local KEY_MODE = hs.keycodes.map["F5"]
local KEY_Q = hs.keycodes.map["q"]
local KEY_E = hs.keycodes.map["e"]
local KEY_SLASH = hs.keycodes.map["/"]
local KEY_ENTER = hs.keycodes.map["return"]
local KEY_DELETE = hs.keycodes.map["delete"]

local MODE_OFF = 0
local MODE_ON = 1
local MODE_BM = 2
local MODE_MM = 3
local MODE_LAST = 3

local MODE_NAMES = {}
MODE_NAMES[MODE_OFF] = "Off"
MODE_NAMES[MODE_ON] = "On"
MODE_NAMES[MODE_BM] = "BM"
MODE_NAMES[MODE_MM] = "MM"

local ACTION_NONE = 0
local ACTION_Q = 1
local ACTION_E = 2

-----------------------------------------------------------------------------------------
-- Globals

local facerollMode = MODE_OFF       -- Which spec are we trying to be right now?
local facerollActive = true         -- An additional way to temporarily behave like MODE_OFF when people hit enter/slash/delete
local facerollAction = ACTION_NONE  -- Which faceroll key action is running? (the "paradigm")
local facerollModeSendRemaining = 0 -- Where are with our rotary-phone-sending of the mode number
local facerollNextActionIndex = 0   -- When invoking nextAction(), where are we in the cycle?

-----------------------------------------------------------------------------------------
-- App interation

local wowApplication = nil
local function sendKeyToWow(keyName)
    -- if wowApplication == nil then
        wowApplication = hs.application.applicationsForBundleID('com.blizzard.worldofwarcraft')[1]
    -- end
    if wowApplication ~= nil then
        hs.eventtap.keyStroke({}, keyName, 20000, wowApplication)
    end
end

-----------------------------------------------------------------------------------------
-- nextAction system

local ACTIONS = {
    [MODE_ON] = {
        [ACTION_Q] = {
            "7", "8", "9", "0", "-", "=", "pad7", "pad8", "pad9",          -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        },
        [ACTION_E] = {
            "F7", "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        },
    },

    [MODE_BM] = {
        [ACTION_Q] = {
            "7", "8", "9", "0", "-", "=", "pad7", "pad8", "pad9",          -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait
        },
        [ACTION_E] = { -- BM AoE (presses F7 a bit every 6 seconds)
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            -- 0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            -- 0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        },
    },
}

local function nextAction(actions)
    if actions == nil then
        -- FRDEBUG("BAIL 2")
        return
    end

    local actionCount = #actions
    if facerollNextActionIndex >= actionCount then
        facerollNextActionIndex = 0
    end

    local key = actions[facerollNextActionIndex + 1]
    if key ~= 0 then
        -- FRDEBUG("FACEROLL KEY: " .. key)
        sendKeyToWow(key)
    end

    facerollNextActionIndex = facerollNextActionIndex + 1
    if facerollNextActionIndex >= actionCount then
        facerollNextActionIndex = 0
    end
end

-----------------------------------------------------------------------------------------
-- The heart of action ticks

local wowTick = hs.timer.new(0.02, function()
    -- FRDEBUG("wowTick")
    if not facerollActive or facerollAction == ACTION_NONE then
        return
    end

    if facerollMode == MODE_ON
    or facerollMode == MODE_BM
    then
        nextAction(ACTIONS[facerollMode][facerollAction])
    elseif facerollMode == MODE_MM then
        print("MM thinky time")
    end

    return
end, true)

-----------------------------------------------------------------------------------------
-- The mechanism used to tell the game which mode we're in (like a rotary phone would)

local wowSendModeTick = hs.timer.new(0.05, function()
    -- FRDEBUG("wowSendModeTick")
    if facerollModeSendRemaining > 0 then
        facerollModeSendRemaining = facerollModeSendRemaining - 1
        sendKeyToWow("[")
    end
    return
end, true)

local function updateMode()
    facerollModeSendRemaining = 0
    sendKeyToWow("]")
    facerollModeSendRemaining = facerollMode
    if not wowSendModeTick:running() then
        wowSendModeTick:start()
    end

    print("Faceroll: " .. MODE_NAMES[facerollMode])
end

-----------------------------------------------------------------------------------------
-- Key handlers

local wowTapKey = hs.eventtap.new({hs.eventtap.event.types.keyDown}, function(event)
    -- local flags = event:getFlags()
    local keyCode = event:getKeyCode()
    -- FRDEBUG("lole key " .. keyCode)

    if keyCode == KEY_MODE then
        if facerollActive then
            facerollMode = facerollMode + 1
            if facerollMode > MODE_LAST then
                facerollMode = MODE_OFF
                facerollActive = false
            end
        else
            facerollActive = true
            if facerollMode == MODE_OFF then
                facerollMode = facerollMode + 1
            end
        end
        facerollNextActionIndex = 0
        updateMode()

    elseif keyCode == KEY_SLASH or keyCode == KEY_ENTER or keyCode == KEY_DELETE then
        facerollActive = false
    elseif facerollActive then
        if keyCode == KEY_Q then
            FRDEBUG("Faceroll: Q")
            facerollAction = ACTION_Q
            if not wowTick:running() then
                wowTick:start()
            end
            return true
        elseif keyCode == KEY_E then
            FRDEBUG("Faceroll: E")
            facerollAction = ACTION_E
            if not wowTick:running() then
                wowTick:start()
            end
            return true
        end
    end
end)

local wowTapFlags = hs.eventtap.new({hs.eventtap.event.types.flagsChanged}, function(event)
    if facerollMode ~= nil then
        FRDEBUG("Faceroll: Reset")
        facerollAction = ACTION_NONE
    end
end)

-----------------------------------------------------------------------------------------
-- Window listener stuff

local function facerollListenStart()
    print("facerollListenStart()")
    wowTapKey:start()
    wowTapFlags:start()
end
local function facerollListenStop()
    print("facerollListenStop()")
    wowTapKey:stop()
    wowTapFlags:stop()
end

local WoWFilter = hs.window.filter.new(true)--"Wow")
WoWFilter:subscribe(hs.window.filter.windowFocused, function(w)
    if w == nil then
        FRDEBUG("Focus: w is nil")
    else
        FRDEBUG("Focus: " .. w:title())
        if w:title() == "World of Warcraft" then
            facerollListenStart()
        end
    end
end)
WoWFilter:subscribe(hs.window.filter.windowUnfocused, function(w)
    if w ~= nil then
        FRDEBUG("Unfocus: " .. w:title())
        if w:title() == "World of Warcraft" then
            facerollListenStop()
        end
    end
end)

-----------------------------------------------------------------------------------------

print("Faceroll loaded.")
