-----------------------------------------------------------------------------------------
-- World of Warcraft Faceroll Logic

-- WAs:
-- FaceRoll:                !WA:2!DA1ZVnoru4gvKwrufnKTSQc4WqyPIvGIwQ0UQCOAvC(bTqsDX2D7UId2J9mozaNzSMzC3eogXbUShOA)licjUG4q2Y1vO9osMQvCgv4mhwH4mJTtlUSTePyPO8EJ)MV5nFVNN3uOv5(LrLrF9n4SizaHI567z1E7DAEmms2JX1dLegvuCcIicdGdTWdKvEhVXErcjRFIx4n9JOEjOE3BueOE4yzeNcQ0YaubuTkagXH2y6bv7Zq4Iyk6yrpiI9G7R77lWY3CHjqQNAP2LrOsxnDll9oHGCRNTpJ3hkTdTLK(4PEfcl9VXWEHiOeBGpatLNOcCMcaXBFcs2tRMYLdtdqXTnesixwuJqjY1oeXSZ4WXn7)WvoxWc2euPJEfxFfCrVIJKCs3UyU4vwJp18x1KddXXx9erKB6QBg57tgmXUEntlBtRAgwJqkktw91Vz1nIx6P17bLGoyHa2fF202LJvtZWC3MTBpjlwS7rqyJKDmAKieheSnsum(QdEPF8m9oDQVpaY7MP8eFq6qGnvbUAXT2ZScGXZnO(UwBRVJAuzpmnDoQ8r6)VibTQvVPHE7221AMdFYZliskeN9YPPFjpcFUf4I520AwCRqmNCVtRzXTcXCYT(oZIBfI5KBnTzXTcXCYDdZzXTcXCYDNzYDN5M79NzDY(ZDDsTzwNuBURt2QXS4wHyEZL1MTINIzo5V923DMF5NI5)L)KFQNSZ5eHpk3XkGChdaY9zli3NzGCFwaYvgdYv2bYvMaa5YRGC5bW50nW52LNEKB6H5lzqH9XIIArQMeUjnHW8XiSR6KDl175B1S9UT2R9Hr0Pnbkg(Qj9xoaBL53rPnF)cHvU8wyk1Zw1ua7eU2Ldka3f6n02pGX49ouGd8t7qg)YA(mQ84w6g1B2ay(P7vZO5yvJedC3KECV(1Ix9yLRl07l6Q6QtrAbmiY)eVaOqydPiBv7eV1CfeA3a8dn6hfij)9rFMZrl7Gk58qNFX5zl7CujNvUUZFTSZFSSZp78noxVKZJk5il54kHbQm51I3Oyy5ib2(882Zi1p51Aj(zgKVeNymkjYnvoBo9oa3l7oalYhKzuympDxKi0AsLMCiKs6N2(82XLAfVQgLrXpfdfytjht7k7DLJpTbBA6JlWEmksmkbtcnXn06dju1CJBe38kXTI)O4TuMV2)DKNRexmNcdURIefDFx4BF5jNqo2JKGAXXQg3yu6Dn(QLcFJlCkzgXVLHhlGX)4TUZF(KN8BlSWclU1D(9h)4FkXI)5QsqI)qT2nBznwY8oilkwTWpSsfcAulOh2GfeSEebnX8(B8j641FaFWGj(Cv1QsmGs4Ipp7MuTsgkzV7Aw3OzZD4dZu3VDzxL24t6wm89U8TgAOQ(N4zl7XXIESa0WrpGXr7ZHHJ2FQXKS0x90TtHcfwCCIOtMExrcnJrLxXlur8ovrAuw4ERQFWhw9wLp4z37Fc
-- FaceRoll Enable/Disable: !WA:2!fwvZUTTXtClOdbGOaw1j1j1TaLqn1iPj1v2k(JCiaX0HcjbswguYjPWn)jxYDP4MqTlXUlDSArVyeuKl5qn6tGU0lf9GqEakkqpwawJC8)PG(ee0hGolPItTJm6cqWzMD(nZS78XwQXm9Nbpd(zFUGNQIPmIO92DBENnTf71omusu3(xt2P8nNAQsJWuzsmAqxYEQQFwWWGuPI3xZLSAyklqr5SlDzdtyjiQubZeLkqUe2Ul0NJjYDog7dnim8HYieM)KVQWtF8uJqSGiUyloLP83WEZU2ojM)l36gYf9rk3exfTpzmxPKkVnu2obJue)08FVcLcIrkAW9PyvK16aRaLhOYvCKkKqzyrzu18hG5UfgXZV4)EL(9JI3qXg8yUW8gMhDovGVUQzGw8XoYv)6fx6AbHHvnxyHIT1eAT1)Z3vuvF0nmo(Tdy8V97oHSDQ9qq8jdJlvTDJgvVQz165RQx(KOwCYO6CVcqRU6KaT0Kb1QLg0ARHq1Q9UGQpzq2nT1OQvRE9RF93f11MmkRCxHqRT2KC1YNYvXMfGghFhhfGOMFiKGLrg7Re0E9ic5)BEXyYVFigQucd7oiHiUTDZTASDtlfW4OTYs7ltiXX3blnELm1NSlHP6aAt3BK7gR3PRBNUR701kfkF811NeHdd1NinCYv1)2euSk6iOBjiauNoBz3S5bPSXHGX8zNF3S5YoBHsYK6nwFdBN2nB6AV56wnTnpbVRvR3k6w3PJw2OIkwxDONv9nCrumXr3MGZoBY))Oc3C)uuYsdl4mVXnmREc)u9YMQiclxp96K3RhN)kMlEKMJBeuIusUmsSKmzpno8)VCvTt30qBe8LDHSpm7tYmZM3qpJ6r5h1DjlHydsEFuoD3IR7wGf)5Ps(OjosPGi7kjZF6tCIj9qbdCdJ5Cr0bigvpDHZwjRsJS5SyCg53iijPJsqy9urN5qmCy0AKNCessaNHL7R1rx1Lv3QpIYaSz1ZU2zYwoBLSvbYp4KsSc5mvsLgubYSfNXnBrW00(dHQlhsp98S5MnBUdbwFuWJ7bZYzyRyoch(QGyKu6IyyxOEoyEFjL1lM8CN(PXk6ZQ8ID8EX0E4kEp37p9E50EVOI35UO3FnT3FpT3pwX7p8(bVlwXtvX7Pv88vOyiloB2nnsMjvsCpUTJCY51BBP5liOFdrtSV(e0by(IXd9FqXq)YlLsXJAztiR84UKgxkzOi)aPVES0ZnhcoQlNdbBs0bssCyXRdwT72TDRHqpfbNpD)PVxYNE6jUebjGkb7w(1aAIGHIVhKpab)uYvoDy4bqpnnWvfjiYiEmEGt(q97wgwIhbDA0WbqnCJUdv8GDlS4fk9lNRkfNC(gOaIdpo20MH8JjF5TOs9)9FcxGVVaLS)9htmkuaJoGQgKcv(1fpc2qlsFl43zdhB7ntQE6Hj0P4cyjWJxCwiT3SwbriiMh8MNWhS99McwhcpicMUDs(tGZbtE8v8Eq5WspMmiZ1cg0gKm7wc4kYeSaRh8UKIRjvliG8WTG99S0J5oSqjyZnGnfysicQNICEIovuEurkoFg9DlvQu5H66EAUxngrzfrpWzmXEXG30lwFgP)YlS41xy5z29Lp4F(d
-- FaceRoll Labels:         !WA:2!1rvqlYrru4zyoeOrYoozZIy8WA0SzLabsIjyGaXPh7XzxMSZMQ71nIh6Q6UQE6sRPQovv9MDYjzmibKqWfpKd50GGxepmKFaI3fBgZrpTKdEEXFaPQUhcAW9u)EV(RQ699vFVQE3wJAHBHF45LICnJYjYb7e0FJT8aXcMqUzVB(3p5j)ATA16DZxO1FDzWF90NAQuVr2fWuvgdnoGSVomrihH0HzHA6isiEmhnIghQtLevQGHhlhpijrr03y5ziECQqUTGY1rD82kWdKT6XVvvz1ZAgNR0Irwe7KHrAcGShHRpeLBQI004DPyDQBBtQefRPcU6AaLgj1oUuov7eLy(OsDMOL0Hdjs1jxtUi8BNIjr5jjbJZiYEE93U7o9D1MeakxIU8evgHX2aRCouLhvES(g009Nf2PTFqOFqBqGBU5qISKGiFfSTLedmG)2E97x4e1JGy6uGrBikNdY5loENS302X7rcQYVLat(5AzN94fLrcCO0ObWJmIirYrSpZqidN)PdqCQvoe8RvCYUfN2Ll4KFJGueFTKWhQtpXCSHuweHwkkvKybhRMyXyfGIZ5ocr5M1wCUI1orX5lwV4dmHnF9kUjcUEE3bGoEFYQ(3EN2aVPgIdidTI)BVsXPNBsJqXF1qJ9IJDzceo5WygsPcrCCOrwJxbmkNPPp8u)ZsqCtOUj8rWVh(NWFOj85lb)XMWN9fWN1e(nWxSe8XWLFF4VdFGP4sW)agPrmJgVsXLCYALRiH)3DofuMB)TB5jvgqVpXgmX27(MK3DUkfHf37ov2ZgtLLTVviC1gHxUF1p69Xt(oODsiBTJ)AHrgIIhhMWeczA27D8aZKKyQ9(Qr2z(FrvfaSGXtnwicU0E)G3yr7(5vD17ut(LMXcAYyayJpTxWuTiEVkNWBv)xw(Su8rDrXeGGXwTpkIWutUNqI3vIYMS7IGzjsJF04oqAuJJQgo7Alz1Gi)oapVTUCofp7U3EZnV(viF4hDL1JmwMe6qN5MPpd8bzLZBoZ(xCr6h440EG3SQgUt57j1RxVXuRDJUybuEftnzohOiSKQNfCheem4wTurx9Ix66x8QT27535L)
-- FaceRoll Labels Bear:    !WA:2!1r1ZVnoru4eLdizwb7gvfHaouwKwoGuLOsBLw6clXPoKSkTPm29hCYDSNNJhy8mdZmUTHtOieAp3t7H9uUWfehYFbi(lWeXrovTh2Z9VGDM4ieGON87n(988999(EUz)2fTjTjp7JuIsdJYb14JIgn8GauQGjupDWtE1ZF(V1OrJbp5LgZpSk4VEXlSN0S1ccvlz4PrWLM5JgECGN3ED3pCPohtex81JZY0G59BSaZtZfQdfuUjPxWbrbi5M)JwJZeQcSjwgBOfW6SMY7MwQnIcxfhjjydGGZbU5ACP9uSHMEcLyY97Atv4udvW17G0gSY4LKr5uDUNV9HXBMrrNmbu636bQ1H)0CcKuMLfnvcQbbJoS)rJ8n2eeUuH3EMwcm2qI27ADzYQRn0wn9YfX96ggfhg1ff5xA)4josakehxaAVQ3mzaGzM8)UTdvGTnu4HbJgDvjF917jVNdXNdr157liWV0q(E)VIsDaYPnKBSsiO4y2Xw6yz8pFLgyz1kR)4OOX77Nj4ML9hJ6fS3MHF1rDrbZTGbbtCc072PQZsBAco9BNyN4CIptGjzxNYWADmMtITupTdQOKzOD(JZsmyMLgDQ2YdTQgxKSDPgI)3TK7VQr7B910VhCbZCqj0M8bRDeNw7iAnxTcnoX33y5Q8JVD3azQvAPPXMCfOZfmY0RWCQB(l47u929)DaRHqJc4tm5VrvhFUGdlj2PORIy3mvPHubNON5k1DPv76xGP8(vFQTHQDREC1Nv952N39)EI8dVDGjvqk1ndAjV)TxvHGeBHcC2CheORCPElTwy7cXyzDQ6BSgDA2ueA4xoiAUrKEE909DA(RBCFkrUrFCkGem2MJWjatVPpGvQP1Q5J3yrMY6(SAa2GBDt9YwF3roUMe2dfeCqI96ZOt82UKswqggL(OTL69d(o1L1FLbFXSDpZTMp7cHICIclNDY6Gf1dVER(DqZMnBn36ObYQTVF8olO8AgBXRN8b3UsWGj40PXzmHqL3wN8WT(KhT1dBF(FE6R)

-- Macros:
-- FRON  ('['): /run WeakAuras.ScanEvents("FACEROLL_ENABLE")
-- FROFF (']'): /run WeakAuras.ScanEvents("FACEROLL_DISABLE")
-- FRBM  ('6'): /run WeakAuras.ScanEvents("FACEROLL_ENABLE_BM")

-- Keybinds:
-- '[', ']', '6'            - see macros
-- 7890-= num7 num8 num9    - ST rotatoe
-- F7-F12 num4 num5 num6    - AOE rotatoe
-- Q, E, F5, /, enter, del  - automatic (see below)

-----------------------------------------------------------------------------------------
-- Basic debug/helper stuff

function FRDEBUG(text)
    -- print("Faceroll: " .. text)
end

function bitand(a, b)
    local result = 0
    local bitval = 1
    while a > 0 and b > 0 do
      if a % 2 == 1 and b % 2 == 1 then -- test the rightmost bits
          result = result + bitval      -- set the current bit
      end
      bitval = bitval * 2 -- shift left
      a = math.floor(a/2) -- shift right
      b = math.floor(b/2)
    end
    return result
end


-----------------------------------------------------------------------------------------
-- Constants

local KEY_TOGGLE = hs.keycodes.map["F5"]
local KEY_MODE = hs.keycodes.map["F5"]
local KEY_Q = hs.keycodes.map["q"]
local KEY_E = hs.keycodes.map["e"]
local KEY_SLASH = hs.keycodes.map["/"]
local KEY_ENTER = hs.keycodes.map["return"]
local KEY_DELETE = hs.keycodes.map["delete"]

local MODE_OFF = 0
local MODE_SV = 1
local MODE_MM = 2
local MODE_ELE = 3
local MODE_BM = 4
local MODE_ON = 5
local MODE_LAST = 5

local MODE_NAMES = {}
MODE_NAMES[MODE_BM] = "BM"
MODE_NAMES[MODE_ELE] = "Ele"
MODE_NAMES[MODE_MM] = "MM"
MODE_NAMES[MODE_OFF] = "Off"
MODE_NAMES[MODE_ON] = "On"
MODE_NAMES[MODE_SV] = "SV"

local ACTION_NONE = 0
local ACTION_Q = 1
local ACTION_E = 2

-----------------------------------------------------------------------------------------
-- Globals

local facerollMode = MODE_OFF       -- Which spec are we trying to be right now?
local facerollActive = true         -- An additional way to temporarily behave like MODE_OFF when people hit enter/slash/delete
local facerollAction = ACTION_NONE  -- Which faceroll key action is running? (the "paradigm")
local facerollModeSendRemaining = 0 -- Where are with our rotary-phone-sending of the mode number
local facerollNextActionIndex = 0   -- When invoking nextAction(), where are we in the cycle?
local facerollGameBits = 0          -- The current game state!

-----------------------------------------------------------------------------------------
-- UDP socket listening for game bits

function onGameBits(newBits, addr)
    -- print("onGameBits: " .. newBits)
    facerollGameBits = tonumber(newBits)
end
server = hs.socket.udp.server(9001, onGameBits):receive()

-----------------------------------------------------------------------------------------
-- App interation

local wowApplication = nil
local function sendKeyToWow(keyName)
    -- if wowApplication == nil then
        wowApplication = hs.application.applicationsForBundleID('com.blizzard.worldofwarcraft')[1]
    -- end
    if wowApplication ~= nil then
        hs.eventtap.keyStroke({}, keyName, 20000, wowApplication)
    end
end

-----------------------------------------------------------------------------------------
-- nextAction system

local ACTIONS = {
    [MODE_ON] = {
        [ACTION_Q] = {
            "7", "8", "9", "0", "-", "=", "pad7", "pad8", "pad9",          -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        },
        [ACTION_E] = {
            "F7", "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        },
    },

    [MODE_BM] = {
        [ACTION_Q] = {
            "7", "8", "9", "0", "-", "=", "pad7", "pad8", "pad9",          -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait
        },
        [ACTION_E] = { -- BM AoE (presses F7 a bit every 6 seconds)
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7", "F7",
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- 0,0,0,0,
            0,0,0,                                                 -- wait

            "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            -- 0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
            -- "F8", "F9", "F10", "F11", "F12", "pad4", "pad5", "pad6", -- send keys
            -- 0,0,0,0,0,0,0,0,0,0,0,0,0,                                     -- wait
        },
    },
}

local function nextAction(actions)
    if actions == nil then
        -- FRDEBUG("BAIL 2")
        return
    end

    local actionCount = #actions
    if facerollNextActionIndex >= actionCount then
        facerollNextActionIndex = 0
    end

    local key = actions[facerollNextActionIndex + 1]
    if key ~= 0 then
        -- FRDEBUG("FACEROLL KEY: " .. key)
        sendKeyToWow(key)
    end

    facerollNextActionIndex = facerollNextActionIndex + 1
    if facerollNextActionIndex >= actionCount then
        facerollNextActionIndex = 0
    end
end

-----------------------------------------------------------------------------------------
-- Marksmanship

local function nextMM()
    facerollNextActionIndex = facerollNextActionIndex + 1
    if facerollNextActionIndex > 10 then
        facerollNextActionIndex = 0
    end
    if facerollNextActionIndex > 1 then
        -- Slow down!
        return
    end

    local trickShots = bitand(facerollGameBits, 0x1)
    local streamline = bitand(facerollGameBits, 0x2)
    local preciseshots = bitand(facerollGameBits, 0x4)
    local spottersmark = bitand(facerollGameBits, 0x8)
    local movingtarget = bitand(facerollGameBits, 0x10)
    local aimedshot = bitand(facerollGameBits, 0x20)
    local rapidfire = bitand(facerollGameBits, 0x40)
    local explosiveshot = bitand(facerollGameBits, 0x80)
    local killshot = bitand(facerollGameBits, 0x100)
    local lowfocus = bitand(facerollGameBits, 0x200)

    if facerollAction == ACTION_Q then
        -- Single Target

        if facerollNextActionIndex == 0 then
            sendKeyToWow("pad9") -- signal we're in ST

        elseif (preciseshots > 0) and (killshot > 0) then
            -- Use Kill Shot when you have a Precise Shots stack.
            sendKeyToWow("=") -- kill shot

        elseif lowfocus > 0 and rapidfire > 0 then
            -- prioritize rapid fire a bit higher here for some quick focus
            sendKeyToWow("8") -- rapid fire

        elseif lowfocus > 0 then
            -- We're super low on focus and don't have rapid fire, just steady shot once
            sendKeyToWow("-") -- steady shot

        elseif (preciseshots > 0) and (spottersmark == 0) and (movingtarget == 0) then
            -- Spend Precise Shots stacks with Arcane Shot, which generates
            -- Streamline to reduce Aimed Shot’s cast time and Focus cost. You
            -- should skip this line if you either have a Spotter's Mark proc,
            -- or you already have Moving Target from having spent Precise Shots
            -- previously.
            sendKeyToWow("pad7") -- arcane shot

        elseif rapidfire > 0 then
            -- Cast Rapid Fire on cooldown to generate Streamline, Deathblow,
            -- Precise Shots (if No Scope is specced), and In the Rhythm. It
            -- also activates Lunar Storm. Delay it for up to 7 seconds if Lunar
            -- Storm is coming off cooldown soon, in order to activate the Lunar
            -- Storm the moment it becomes available.
            sendKeyToWow("8") -- rapid fire

        elseif aimedshot > 0 and streamline > 0 then
            -- Use Aimed Shot as often as you can. Most of the time, we want to
            -- get rid of our Precise Shots stacks first, but if you have both a
            -- Spotter's Mark proc and  Moving Target up, you should just cast
            -- Aimed Shot regardless.
            sendKeyToWow("9") -- aimed shot

        elseif explosiveshot > 0 then
            -- Use Explosive Shot whenever possible.
            sendKeyToWow("0") -- explosive shot

        else
            -- Use Steady Shot as a Focus generator when no other abilities are
            -- available. Each cast gives 20 Focus, so avoid casting multiple
            -- times in a row if you risk Focus capping.
            sendKeyToWow("-") -- steady shot
        end

    elseif facerollAction == ACTION_E then
        -- AOE

        if facerollNextActionIndex == 0 then
            sendKeyToWow("pad6") -- signal we're in AOE

        elseif lowfocus > 0 then
            -- We're super low on focus and don't want to spend rapid fire without trickshots, just steady shot once
            sendKeyToWow("-") -- steady shot

        elseif (trickShots == 0) or ((preciseshots > 0) and (spottersmark == 0) and (movingtarget == 0)) then
            -- You should use Multi-Shot to activate Trick Shots if it is down.
            -- You should also use it to spend Precise Shots stacks, but only if
            -- you do not have both Spotter's Mark and Moving Target active. If
            -- we have either of these buffs, we can just cast Aimed Shot,
            -- provided we have a Trick Shots.
            sendKeyToWow("7") -- multishot

        elseif rapidfire > 0 then
            -- Cast Rapid Fire on cooldown to generate Streamline, Deathblow,
            -- Precise Shots (if No Scope is specced), and In the Rhythm. It
            -- also activates Lunar Storm. Delay it for up to 7 seconds if Lunar
            -- Storm is coming off cooldown soon, in order to activate the Lunar
            -- Storm the moment it becomes available. You should ensure that
            -- Trick Shots is active before you cast it, and ideally with more
            -- uptime remaining than the channel time (2s).
            sendKeyToWow("8") -- rapid fire

        elseif explosiveshot > 0 then
            -- Use Explosive Shot whenever possible.
            sendKeyToWow("0") -- explosive shot

        elseif aimedshot > 0 and streamline > 0 then
            -- Use Aimed Shot as often as you can. Most of the time, we want to
            -- get rid of our Precise Shots stacks first, but if you have both a
            -- Spotter's Mark proc and  Moving Target up, you should just cast
            -- Aimed Shot regardless. Of course, we should always make sure to
            -- apply Trick Shots first.
            sendKeyToWow("9") -- aimed shot

        else
            -- Cast Steady Shot as a filler and Focus generator, when nothing
            -- higher in the priority list is available.
            sendKeyToWow("-") -- steady shot
        end
    end
end

-----------------------------------------------------------------------------------------
-- Survival

local function nextSV()
    facerollNextActionIndex = facerollNextActionIndex + 1
    if facerollNextActionIndex > 10 then
        facerollNextActionIndex = 0
    end
    if facerollNextActionIndex > 1 then
        -- Slow down!
        return
    end

    local lunarstorm = bitand(facerollGameBits, 0x1)
    local strikeitrich = bitand(facerollGameBits, 0x2)
    local tipofthespear = bitand(facerollGameBits, 0x4)
    local wildfirebomb2 = bitand(facerollGameBits, 0x8)
    local wildfirebomb1 = bitand(facerollGameBits, 0x10)
    local butchery = bitand(facerollGameBits, 0x20)
    local killcommand = bitand(facerollGameBits, 0x40)
    local explosiveshot = bitand(facerollGameBits, 0x80)
    local killshot = bitand(facerollGameBits, 0x100)
    local furyoftheeagle = bitand(facerollGameBits, 0x200)
    local highfocus = bitand(facerollGameBits, 0x400)

    if facerollAction == ACTION_Q then
        -- Single Target

        if facerollNextActionIndex == 0 then
            sendKeyToWow("pad9") -- signal we're in ST

        elseif lunarstorm > 0 and wildfirebomb1 > 0 then
            -- Cast Wildfire Bomb to trigger Lunar Storm whenever it is not on
            -- cooldown, regardless of Tip of the Spear.
            sendKeyToWow("7") -- wildfire bomb

        elseif strikeitrich > 0 and tipofthespear == 0 and killcommand > 0 then
            -- Cast Raptor Strike (or Mongoose Bite) with Tip of the Spear to
            -- consume Strike it Rich. If you do not have Tip of the Spear, you
            -- can use Kill Command without regard for focus to bruteforce
            -- getting one quick. This is virtually equal DPS but can be useful
            -- when bursting down a priority target.
            sendKeyToWow("8") -- kill command

        elseif strikeitrich > 0 and tipofthespear == 1 then
            -- Cast Raptor Strike (or Mongoose Bite) with Tip of the Spear to
            -- consume Strike it Rich.
            sendKeyToWow("9") -- raptor strike

        elseif wildfirebomb2 > 0 then
            -- Cast Wildfire Bomb with or without Tip of the Spear if you have 2
            -- charges of Wildfire Bomb, or if you are about to use Coordinated
            -- Assault.
            sendKeyToWow("7") -- wildfire bomb

        elseif wildfirebomb1 > 0 and tipofthespear > 0 then
            -- Cast Wildfire Bomb with Tip of the Spear if you have ~1.7+
            -- charges of Wildfire Bomb.
            sendKeyToWow("7") -- wildfire bomb

        elseif butchery > 0 then
            -- Cast Butchery to apply Merciless Blow.
            sendKeyToWow("0") -- butchery

        elseif furyoftheeagle > 0 and tipofthespear > 0 then
            -- Cast Fury of the Eagle if you have a Tip of the Spear stack to
            -- spend, and you won't need Fury of the Eagle for AoE in the near
            -- future.
            sendKeyToWow("-") -- fury of the eagle

        elseif killcommand > 0 and highfocus == 0 then
            -- Cast Kill Command if you will not over-cap the Focus it
            -- generates.
            sendKeyToWow("8") -- kill command

        elseif wildfirebomb1 > 0 and tipofthespear > 0 then
            -- Cast Wildfire Bomb if you have a Tip of the Spear stack to spend,
            -- and if you will have at least 1 charge left by the time the
            -- cooldown of Lunar Storm ends.
            sendKeyToWow("7") -- wildfire bomb

        elseif killshot > 0 then
            -- Cast Kill Shot.
            sendKeyToWow("=") -- kill shot

        elseif explosiveshot > 0 then
            -- Cast Explosive Shot.
            sendKeyToWow("pad7") -- explosive shot

        else
            -- Cast Raptor Strike(or Mongoose Bite).
            sendKeyToWow("9") -- raptor strike
        end

    elseif facerollAction == ACTION_E then
        -- AOE

        if facerollNextActionIndex == 0 then
            sendKeyToWow("pad6") -- signal we're in AOE

        elseif (lunarstorm > 0 and wildfirebomb1 > 0) or wildfirebomb2 > 0 then
            -- Cast Wildfire Bomb Under any of the following cirumstances:
            -- - To trigger Lunar Storm whenever it is not on cooldown.
            -- - If you have 2 charges of Wildfire Bomb.
            sendKeyToWow("7") -- wildfire bomb

        elseif strikeitrich > 0 then
            -- Cast Raptor Strike to consume Strike it Rich.
            sendKeyToWow("9") -- raptor strike

        elseif butchery > 0 then
            -- Cast Butchery.
            sendKeyToWow("0") -- butchery

        elseif furyoftheeagle > 0 and tipofthespear > 0 then
            -- Cast Fury of the Eagle if you have a Tip of the Spear stack to
            -- spend.
            sendKeyToWow("-") -- fury of the eagle

        elseif killcommand > 0 and highfocus == 0 then
            -- Cast Kill Command if you will not over-cap the Focus it
            -- generates.
            sendKeyToWow("8") -- kill command

        elseif explosiveshot > 0 then
            -- Cast Explosive Shot.
            sendKeyToWow("pad7") -- explosive shot

        elseif wildfirebomb1 > 0 and tipofthespear > 0 then
            -- Cast Wildfire Bomb if you have a Tip of the Spear stack to spend.
            sendKeyToWow("7") -- wildfire bomb

        else
            -- Cast Raptor Strike(or Mongoose Bite).
            sendKeyToWow("9") -- raptor strike
        end
    end
end

-----------------------------------------------------------------------------------------
-- Elemental

local function nextElemental()
    facerollNextActionIndex = facerollNextActionIndex + 1
    if facerollNextActionIndex > 10 then
        facerollNextActionIndex = 0
    end
    if facerollNextActionIndex > 1 then
        -- Slow down!
        return
    end

    local tempest = bitand(facerollGameBits, 0x1)
    local enough_maelstrom = bitand(facerollGameBits, 0x2)
    local flameshock_on_target = bitand(facerollGameBits, 0x4)
    local stormkeeper = bitand(facerollGameBits, 0x8)

    if facerollAction == ACTION_Q then
        -- Single Target

        if facerollNextActionIndex == 0 then
            sendKeyToWow("pad9") -- signal we're in ST

        elseif stormkeeper > 0 then
            sendKeyToWow("=") -- stormkeeper

        elseif flameshock_on_target == 0 then
            sendKeyToWow("-") -- flame shock

        elseif enough_maelstrom > 0 then
            sendKeyToWow("0") -- earth shock

        else
            sendKeyToWow("7") -- lightning bolt
        end

    elseif facerollAction == ACTION_E then
        -- AOE

        if facerollNextActionIndex == 0 then
            sendKeyToWow("pad6") -- signal we're in AOE

        elseif stormkeeper > 0 then
            sendKeyToWow("=") -- stormkeeper

        elseif tempest > 0 then
            sendKeyToWow("7") -- "tempest" (its actually just lightning bolt)

        elseif enough_maelstrom > 0 then
            sendKeyToWow("9") -- earthquake

        else
            sendKeyToWow("8") -- chain lightning
        end
    end
end

-----------------------------------------------------------------------------------------
-- The heart of action ticks

local wowTick = hs.timer.new(0.02, function()
    -- FRDEBUG("wowTick")
    if not facerollActive or facerollAction == ACTION_NONE then
        return
    end

    if facerollMode == MODE_ON
    or facerollMode == MODE_BM
    then
        nextAction(ACTIONS[facerollMode][facerollAction])
    elseif facerollMode == MODE_MM then
        nextMM()
    elseif facerollMode == MODE_ELE then
        nextElemental()
    elseif facerollMode == MODE_SV then
        nextSV()
    end

    return
end, true)

-----------------------------------------------------------------------------------------
-- The mechanism used to tell the game which mode we're in (like a rotary phone would)

local wowSendModeTick = hs.timer.new(0.05, function()
    -- FRDEBUG("wowSendModeTick")
    if facerollModeSendRemaining > 0 then
        facerollModeSendRemaining = facerollModeSendRemaining - 1
        sendKeyToWow("[")
    end
    return
end, true)

local function updateMode()
    facerollModeSendRemaining = 0
    sendKeyToWow("]")
    facerollModeSendRemaining = facerollMode
    if not wowSendModeTick:running() then
        wowSendModeTick:start()
    end

    print("Faceroll: " .. MODE_NAMES[facerollMode])
end

-----------------------------------------------------------------------------------------
-- Key handlers

local wowTapKey = hs.eventtap.new({hs.eventtap.event.types.keyDown}, function(event)
    -- local flags = event:getFlags()
    local keyCode = event:getKeyCode()
    -- FRDEBUG("lole key " .. keyCode)

    if keyCode == KEY_MODE then
        if facerollActive then
            facerollMode = facerollMode + 1
            if facerollMode > MODE_LAST then
                facerollMode = MODE_OFF
                facerollActive = false
            end
        else
            facerollActive = true
            if facerollMode == MODE_OFF then
                facerollMode = facerollMode + 1
            end
        end
        facerollNextActionIndex = 0
        updateMode()

    elseif keyCode == KEY_SLASH or keyCode == KEY_ENTER or keyCode == KEY_DELETE then
        facerollActive = false
    elseif facerollActive then
        if keyCode == KEY_Q then
            FRDEBUG("Faceroll: Q")
            facerollAction = ACTION_Q
            if not wowTick:running() then
                wowTick:start()
            end
            return true
        elseif keyCode == KEY_E then
            FRDEBUG("Faceroll: E")
            facerollAction = ACTION_E
            if not wowTick:running() then
                wowTick:start()
            end
            return true
        end
    end
end)

local wowTapFlags = hs.eventtap.new({hs.eventtap.event.types.flagsChanged}, function(event)
    if facerollMode ~= nil then
        FRDEBUG("Faceroll: Reset")
        facerollAction = ACTION_NONE
    end
end)

-----------------------------------------------------------------------------------------
-- Window listener stuff

local function facerollListenStart()
    print("facerollListenStart()")
    wowTapKey:start()
    wowTapFlags:start()
end
local function facerollListenStop()
    print("facerollListenStop()")
    wowTapKey:stop()
    wowTapFlags:stop()
end

local WoWFilter = hs.window.filter.new(true)--"Wow")
WoWFilter:subscribe(hs.window.filter.windowFocused, function(w)
    if w == nil then
        FRDEBUG("Focus: w is nil")
    else
        FRDEBUG("Focus: " .. w:title())
        if w:title() == "World of Warcraft" then
            facerollListenStart()
        end
    end
end)
WoWFilter:subscribe(hs.window.filter.windowUnfocused, function(w)
    if w ~= nil then
        FRDEBUG("Unfocus: " .. w:title())
        if w:title() == "World of Warcraft" then
            facerollListenStop()
        end
    end
end)

-----------------------------------------------------------------------------------------

print("Faceroll loaded.")
